<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.seohan.mat.mapper">

	<select id="findGetOmissionItemList" resultType="com.seohan.mat.Dto.ImportPlanAlarm" parameterType="com.seohan.mat.Dto.ImportPlanAlarmQuery"><![CDATA[
		SELECT A.CSTCD, A.ITMNO, B.WARHS, B.MQTY, C.BSQTY, C.TSQTY, D.PRE_QTY, (B.MQTY - C.BSQTY + D.PRE_QTY -  C.TSQTY) EXPQTY , E.CUSNA,F.DSCRP FROM (
		SELECT CSTCD, ITMNO FROM SMLIB.CSTPLT WHERE ACTGB != 'C'  AND FILL1 = #{userid}
		) A
		Inner Join  (SELECT ITMNO, WARHS, MQTY FROM SMLIB.PUR_BALSET WHERE  GDATE = #{workdate}) B ON A.ITMNO = B.ITMNO
		LEFT OUTER JOIN (
		SELECT CSTCD, WARHS, MITMNO,
		SUM(CASE WHEN PDATE != #{todate} THEN SSQTY ELSE 0 END) BSQTY,
		SUM(CASE WHEN PDATE = #{todate} THEN SSQTY ELSE 0 END) TSQTY  FROM SMLIB.PUR_PLNB
		WHERE PDATE BETWEEN #{workdate} AND #{todate} GROUP BY CSTCD,WARHS, MITMNO
		) C ON A.ITMNO = C.MITMNO AND A.CSTCD =C.CSTCD AND B.WARHS = C.WARHS
		LEFT OUTER JOIN (
		SELECT  CSTCD, WARHS, ITMNO,
		(SUM(CASE WHEN LEFT(TRSCD, 1) = 'R' AND TRGAE NOT IN ('AG','SC') AND LOTNO != 'SSSSSS' THEN QUNTY ELSE 0 END)
		- SUM(CASE WHEN LEFT(TRSCD, 1) = 'I' AND TRGAE = 'AG' AND LOTNO != 'SSSSSS' THEN QUNTY ELSE 0 END)) PRE_QTY  FROM SMLIB.TRANSPF
		WHERE TRSDT BETWEEN #{fromdate} and #{workdate} GROUP BY CSTCD,WARHS, ITMNO
		) D ON A.ITMNO = D.ITMNO AND A.CSTCD = D.CSTCD AND B.WARHS = D.WARHS
		INNER JOIN SALIB.CUSTP E ON A.CSTCD= E.CODE1||E.CODE2
		INNER JOIN SMLIB.ITMSTPF F ON A.ITMNO = F.ITMNO
		WHERE (B.MQTY - C.BSQTY + D.PRE_QTY -  C.TSQTY) < 0  ]]>
	</select>
</mapper>
